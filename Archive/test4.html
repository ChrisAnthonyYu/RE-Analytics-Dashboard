<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Windfield Real Estate Financials</title>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --color-primary:#1E424A;
      --color-secondary:#3A878C;
      --color-accent:#57B2B8;
      --color-supporting:#5C7C9E;
      --color-light-bg:#f8fafc;
      --color-white:#ffffff;
      --color-gray-100:#f1f5f9;
      --color-gray-200:#e2e8f0;
      --color-gray-600:#475569;
      --color-gray-800:#1e2b3b;
      --color-highlight:#e0f2fe;
      --color-success:#10b981;
      --color-error:#ef4444;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:var(--color-light-bg);
      color:var(--color-gray-800);
      font-size:16px;
    }
    
    #sticky-header-container {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: var(--color-white);
    }
    .header{
      background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-secondary) 100%);
      color:#fff;padding:1.25rem 2rem;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .header h1{font-weight:300;font-size:2rem;}
    .filters-bar{
      background: linear-gradient(180deg, rgba(30,66,74,0.12) 0%, rgba(87,178,184,0.10) 100%), var(--color-white);
      border-bottom:1px solid var(--color-gray-200);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    .filters-inner{max-width:1600px;margin:0 auto; padding:0.85rem 1.25rem;}
    .controls{background:var(--color-white);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.08);border-left:4px solid var(--color-accent);padding:0.75rem 1rem;}
    .controls-grid{display:grid; gap:1rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:end;}
    .form-group{display:flex;flex-direction:column;}
    .form-group label{font-size:0.9rem;color:var(--color-gray-800);margin-bottom:0.4rem;}
    select,input{padding:0.6rem;border:1px solid var(--color-gray-200);border-radius:8px;background:var(--color-white); font-size:1rem;}
    .nav-container{background:var(--color-white);border-bottom:3px solid var(--color-accent);box-shadow:0 2px 4px rgba(0,0,0,0.06);}
    .nav-tabs{max-width:1600px;margin:0 auto;padding:0 1.25rem;display:flex; gap:0.5rem; flex-wrap:wrap;}
    .nav-tab{background:none;border:none;cursor:pointer;padding:0.9rem 1.1rem;border-bottom:3px solid transparent;color:var(--color-gray-600); font-weight:500;transition:all .2s ease; white-space:nowrap;}
    .nav-tab:hover{background:var(--color-gray-100);color:var(--color-secondary);}
    .nav-tab.active{color:var(--color-primary);border-bottom-color:var(--color-accent);}
    .sub-nav-container{background: var(--color-white); border-bottom: 1px solid var(--color-gray-200);}
    .sub-nav-tabs{display:flex; gap:0.5rem; flex-wrap:wrap;}
    .sub-nav-tab{background:none; border:none; cursor:pointer; padding:0.8rem 1rem; border-bottom:2px solid transparent; color:var(--color-gray-600); font-weight:500; transition: color .2s ease, border-color .2s ease;}
    .sub-nav-tab:hover{color:var(--color-secondary);}
    .sub-nav-tab.active{color:var(--color-primary); border-bottom-color:var(--color-secondary);}
    .sub-tab-content{display:none;} .sub-tab-content.active{display:block;}
    .container{max-width:1600px;margin:1.25rem auto 2rem; padding:0 1.25rem;}
    .tab-content{display:none;} .tab-content.active{display:block;}
    .card{background:#fff;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;margin-bottom:1.25rem;}
    .card-header{display:flex;justify-content:space-between;align-items:center;background:var(--color-gray-100);color:var(--color-primary);padding:1rem 1.25rem; font-weight:600; border-bottom:1px solid var(--color-gray-200);}
    .card-body{padding:1.25rem;}
    .loading{padding:2rem;text-align:center;color:var(--color-gray-600);}
    .kpi-grid{display:grid;gap:1.25rem;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));}
    .kpi-item p{margin:0.25rem 0;}
    .loan-list{margin:0.5rem 0 0.25rem 0; list-style: none; padding-left: 0;}
    .loan-list li{margin-bottom:0.75rem; line-height: 1.5;}
    .table-container{overflow-x: auto;}

    /* --- STYLING CHANGES START HERE --- */
    .report-table{width:100%;border-collapse:collapse;margin-top:0.5rem; font-size: 0.95rem;}
    .report-table thead{
        background: var(--color-primary); /* Header Color Change */
        color: var(--color-white);
        font-size:0.9rem;
    }
    .report-table th, .report-table td{
        padding:0.75rem;
        border:1px solid #eef2f7; /* Lighter Grid Lines */
        text-align:left;
        white-space:nowrap;
    }
    .report-table td:not(:first-child){text-align:right;}
    .report-table tbody tr:nth-child(even){background:var(--color-light-bg);}
    .report-table .highlight-row{font-weight:bold; background-color:var(--color-highlight); border-top: 2px solid var(--color-secondary);}
    .report-table .group-header-row {font-weight: bold; background-color: var(--color-gray-100);}
    .report-table .account-row td:first-child {padding-left: 2rem;}
    .report-table .highlight-row td:first-child,
    .report-table .group-header-row td:first-child {
        color: var(--color-supporting); /* Total Account Text Color Change */
    }
    /* --- STYLING CHANGES END HERE --- */
  </style>
</head>
<body>
  <div id="sticky-header-container">
    <header class="header"><h1>Windfield Real Estate Financials</h1></header>
    <div class="filters-bar"><div class="filters-inner"><div class="controls"><div class="controls-grid"><div class="form-group"><label for="globalProperty">Property</label><select id="globalProperty" onchange="onGlobalFiltersChange()"></select></div><div class="form-group"><label for="globalMonth">Month</label><select id="globalMonth" onchange="onGlobalFiltersChange()"></select></div><div class="form-group"><label for="globalYear">Year</label><select id="globalYear" onchange="onGlobalFiltersChange()"></select></div></div></div></div></div>
    <nav class="nav-container"><div class="nav-tabs"><button class="nav-tab active" onclick="showTab('home', this)">Home</button><button class="nav-tab" onclick="showTab('financial-statements', this)">Financial Statements</button><button class="nav-tab" onclick="showTab('cashflow-overview', this)">Cashflow</button><button class="nav-tab" onclick="showTab('settings', this)">Settings</button></div></nav>
    <div class="sub-nav-container" id="cashflowSubNav" style="display:none;"><div class="nav-tabs" style="padding: 0 1.25rem;"><button class="sub-nav-tab active" onclick="showCashflowSubTab('cf-overview', this)">Overview</button><button class="sub-nav-tab" onclick="showCashflowSubTab('cf-cashflow', this)">Cashflow</button><button class="sub-nav-tab" onclick="showCashflowSubTab('cf-rentroll', this)">Rent Roll</button></div></div>
  </div>

  <main class="container">
    <section id="home" class="tab-content active"><div id="homeContent" class="card"><div class="card-header">Properties Overview</div><div class="card-body"><div class="loading">Loading data from GitHubâ€¦</div></div></div></section>
    <section id="financial-statements" class="tab-content"><div class="card"><div class="card-header">Financial Statements</div><div class="card-body"><button class="btn">Trial Balance</button> <button class="btn">Income Statement</button> <button class="btn">Balance Sheet</button></div></div></section>
    <section id="cashflow-overview" class="tab-content">
       <div id="cfMessage" class="loading card" style="display:block;">Please select a property from the top filter bar to view Cashflow Analytics.</div>
       <div id="cfContentContainer" style="display:none;">
            <div id="cf-overview" class="sub-tab-content active"><div class="kpi-grid"><div class="card"><div class="card-header">Property Details</div><div class="card-body kpi-item"><p><strong>Property Name:</strong> <span id="cf-property-name">-</span></p><p><strong>Address:</strong> <span id="cf-property-address">-</span></p><p><strong>Property Type:</strong> <span id="cf-property-type">-</span></p><p><strong>Owner:</strong> <span id="cf-property-owner">-</span></p></div></div><div class="card"><div class="card-header">Loan Information</div><div class="card-body"><ul id="cf-loans" class="loan-list"></ul></div></div></div></div>
            <div id="cf-cashflow" class="sub-tab-content"><div class="card"><div class="card-header">Cashflow Report</div><div class="card-body"><div id="cashflowReportContainer" class="table-container"></div></div></div></div>
            <div id="cf-rentroll" class="sub-tab-content"><div class="card"><div class="card-header">Rent Roll</div><div class="card-body loading">Rent Roll data and functionality will be added here.</div></div></div>
       </div>
    </section>
    <section id="settings" class="tab-content"><div class="card"><div class="card-header">Manage Years</div><div class="card-body"><input type="number" id="newYearInput" placeholder="e.g., 2026"><button class="btn" onclick="handleAddYear()">Add Year</button><p id="settingsStatus"></p></div></div></section>
  </main>

<script>
const appData = {};
let availableYears = [2023, 2024, 2025];
let cashflowYears = [];
const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/ChrisAnthonyYu/RE-Analytics-Dashboard/main/Data%20Source/';
const FILE_NAMES = { 
    PROPERTIES:'Properties.csv', LOANS:'Loans.csv', LOAN_INFO:'Loan_Information.csv',
    TRIAL_BALANCE: 'Trial_Balance.csv', MAPPING: 'Mapping_FSaccounts.csv'
};
const REQUIRED_FILES = Object.values(FILE_NAMES);
const MONTH_NAMES = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const MONTH_NAMES_SHORT = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

document.addEventListener('DOMContentLoaded', ()=>{ loadDataFromGithub(); });

function showTab(id, el){
  document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(x=>x.classList.remove('active'));
  if(el) el.classList.add('active');
  document.getElementById('cashflowSubNav').style.display = (id === 'cashflow-overview') ? 'block' : 'none';
  updateGlobalYearFilterForTab(id);
  if(id === 'home') renderHomeView();
  if(id === 'cashflow-overview') {
      renderCashflowOverview();
      showCashflowSubTab('cf-overview', document.querySelector('.sub-nav-tab'));
  }
}

function showCashflowSubTab(id, el) {
    document.querySelectorAll('.sub-tab-content').forEach(x => x.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.sub-nav-tab').forEach(x => x.classList.remove('active'));
    if(el) el.classList.add('active');
}

async function loadDataFromGithub(){
  const results = await Promise.all(REQUIRED_FILES.map(f=>fetch(GITHUB_BASE_URL+f).then(r=>r.text()).then(txt=>new Promise(res=>{
    Papa.parse(txt,{header:true,skipEmptyLines:true,dynamicTyping:true,transformHeader:h=>h.trim().toLowerCase().replace(/ /g,'_'),complete:r=>res({name:f,data:r.data})});
  }))));
  results.forEach(r=>{ const key=Object.keys(FILE_NAMES).find(k=>FILE_NAMES[k]===r.name); appData[key.toLowerCase()] = r.data; });
  if (appData.loans && appData.loans.length > 0) {
    cashflowYears = [...new Set(appData.loans.map(item => item.year))].filter(Boolean).sort((a,b) => b-a);
  }
  populateGlobalFilters();
  updateGlobalYearFilterForTab('home');
  renderHomeView();
}

function populateGlobalFilters(){
  const propSel=document.getElementById('globalProperty');
  propSel.innerHTML='<option value="all">All Properties</option>';
  (appData.properties||[]).forEach(p=>{propSel.innerHTML+=`<option value="${p.property_id}">${p.properties||p.property}</option>`;});
  const monthSel=document.getElementById('globalMonth');
  monthSel.innerHTML='<option value="all">All Months</option>';
  MONTH_NAMES.forEach((m,i)=>monthSel.innerHTML+=`<option value="${i+1}">${m}</option>`);
}

function updateGlobalYearFilterForTab(tabId) {
    const yearSelect = document.getElementById('globalYear'); const currentValue = yearSelect.value;
    let newOptions = (tabId === 'cashflow-overview') ? cashflowYears : availableYears;
    yearSelect.innerHTML = '<option value="all">All Years</option>';
    let selectedValueExists = false;
    newOptions.sort((a,b)=>b-a).forEach(y => {
        const isSelected = String(y) === String(currentValue);
        if(isSelected) selectedValueExists = true;
        yearSelect.innerHTML += `<option value="${y}" ${isSelected ? 'selected' : ''}>${y}</option>`;
    });
    if (!selectedValueExists) { yearSelect.value = 'all'; }
}

function onGlobalFiltersChange(){
  const activeTabId = document.querySelector('.tab-content.active')?.id;
  if(activeTabId === 'home') renderHomeView();
  if(activeTabId === 'cashflow-overview') renderCashflowOverview();
}

function renderHomeView(){
  const body=document.querySelector('#homeContent .card-body');
  const [p, y, m] = [document.getElementById('globalProperty').value, document.getElementById('globalYear').value, document.getElementById('globalMonth').value];
  body.innerHTML=`Filters applied: Property ${p}, Year ${y}, Month ${m}`;
}

function renderCashflowOverview(){
  const propId = document.getElementById('globalProperty').value;
  const year = document.getElementById('globalYear').value;
  const cfContent = document.getElementById('cfContentContainer');
  const msg = document.getElementById('cfMessage');

  if(propId === 'all'){
    cfContent.style.display='none'; msg.style.display='block';
    msg.textContent='Please select a property to view Cashflow Analytics.';
    return;
  }
  const prop = (appData.properties||[]).find(p=>String(p.property_id).toLowerCase()===String(propId).toLowerCase());
  const loans = (appData.loan_info||[]).filter(l=>String(l.property_id).toLowerCase()===String(propId).toLowerCase());
  const loanForAddress = loans.length > 0 ? loans[0] : null;
  document.getElementById('cf-property-name').textContent=prop?.properties||prop?.property||'-';
  document.getElementById('cf-property-address').textContent=loanForAddress?.address || prop?.address || '-';
  document.getElementById('cf-property-type').textContent=prop?.property_type||'-';
  document.getElementById('cf-property-owner').textContent=prop?.owner||'-';
  const ul=document.getElementById('cf-loans'); ul.innerHTML='';
  if (loans.length === 0) { ul.innerHTML = '<li>No loan information found for this property.</li>';
  } else {
    loans.forEach(li=>{
      ul.innerHTML+=`<li><strong>Banker:</strong> ${li.banker||'-'} | <strong>Loan #:</strong> ${li.loan_number||'-'} | <strong>Rate:</strong> ${formatPercent(li.rate)} | <strong>Maturity:</strong> ${li.maturity_date||'-'} <br> <strong>Loan Amount:</strong> ${formatCurrency(li.loan_amount)}</li>`;
    });
  }
  renderCashflowReportTable(propId, year);
  msg.style.display='none'; cfContent.style.display='block';
}

function evaluateFormula(formula, reportMap) {
    if (!formula) return Array(12).fill(0);
    const terms = formula.split(/([+\-])/);
    let totalMonthlyValues = Array(12).fill(0);
    let currentOperator = '+';

    terms.forEach(term => {
        term = term.trim();
        if (term === '+' || term === '-') {
            currentOperator = term;
        } else if (term) {
            const values = reportMap.get(term)?.monthlyValues || Array(12).fill(0);
            if (currentOperator === '+') {
                totalMonthlyValues = totalMonthlyValues.map((v, i) => v + values[i]);
            } else if (currentOperator === '-') {
                totalMonthlyValues = totalMonthlyValues.map((v, i) => v - values[i]);
            }
        }
    });
    return totalMonthlyValues;
}

function parseCurrency(value) {
    if (typeof value === 'number') return value;
    if (typeof value !== 'string') return 0;
    const number = Number(value.replace(/[^0-9.-]+/g, ""));
    return isFinite(number) ? number : 0;
}

function renderCashflowReportTable(propId, year) {
    const container = document.getElementById('cashflowReportContainer');
    if (year === 'all') { container.innerHTML = `<div class="loading">Please select a specific year to view the Cashflow Report.</div>`; return; }
    const filteredTB = (appData.trial_balance || []).filter(row => String(row.property_id).toLowerCase() === String(propId).toLowerCase() && +row.year === +year);
    if (filteredTB.length === 0) { container.innerHTML = `<div class="loading">No cashflow data available for the selected property and year.</div>`; return; }

    const mapping = (appData.mapping || []).filter(item => item.order_cf).sort((a,b) => a.order_cf - b.order_cf);
    let reportMap = new Map();
    mapping.forEach(item => reportMap.set(item.account_ref, { ...item, accounts: {}, monthlyValues: Array(12).fill(0) }));
    
    // --- STEP 1: Aggregate Trial Balance data into the correct account groups ---
    filteredTB.forEach(tbRow => {
        const group = [...reportMap.values()].find(g => 
            tbRow.account_id >= g.account_id_from && tbRow.account_id <= g.account_id_to
        );

        if (group) {
            const accountName = tbRow.accounts;
            if (!group.accounts[accountName]) {
                group.accounts[accountName] = { label: accountName, accountId: tbRow.account_id, monthlyValues: Array(12).fill(0) };
            }
            const monthIndex = MONTH_NAMES.findIndex(m => m.toLowerCase() === String(tbRow.month).trim().toLowerCase());
            if (monthIndex !== -1) {
                let amount = parseCurrency(tbRow.amount);
                
                if (group.account_ref.startsWith('adj_')) {
                    if (parseCurrency(tbRow.debit) > 0) {
                        amount = -amount;
                    }
                }
                
                group.accounts[accountName].monthlyValues[monthIndex] += amount;
            }
        }
    });

    // --- STEP 2: Calculate direct aggregation group totals ---
    reportMap.forEach(group => {
        if (Object.keys(group.accounts).length > 0) {
             group.monthlyValues = Object.values(group.accounts).reduce((totals, account) => {
                account.monthlyValues.forEach((val, i) => totals[i] += val);
                return totals;
            }, Array(12).fill(0));
        }
    });

    // --- STEP 3: DYNAMICALLY Perform hierarchical calculations ---
    mapping.forEach(group => {
        if (group.calculation_formula) {
            const calculatedValues = evaluateFormula(group.calculation_formula, reportMap);
            if (reportMap.has(group.account_ref)) {
                reportMap.get(group.account_ref).monthlyValues = calculatedValues;
            }
        }
    });
    
    // --- STEP 4: Render the table ---
    let tableHTML = `<table class="report-table"><thead><tr><th>Account</th>${MONTH_NAMES_SHORT.map(m => `<th>${m}</th>`).join('')}<th>Total</th></tr></thead><tbody>`;
    
    reportMap.forEach(group => {
        const childAccounts = Object.values(group.accounts).sort((a, b) => String(a.accountId).localeCompare(String(b.accountId)));
        const isTotalLine = group.fs === 'Total';

        if (!isTotalLine && childAccounts.length > 0) {
             childAccounts.forEach(account => {
                const total = account.monthlyValues.reduce((a, b) => a + b, 0);
                tableHTML += `<tr class="account-row"><td>${account.label}</td>`;
                account.monthlyValues.forEach(value => { tableHTML += `<td>${formatCurrency(value)}</td>`; });
                tableHTML += `<td>${formatCurrency(total)}</td></tr>`;
            });
             
             const total = group.monthlyValues.reduce((a, b) => a + b, 0);
             tableHTML += `<tr class="group-header-row"><td>${group.account}</td>`;
             group.monthlyValues.forEach(value => { tableHTML += `<td>${formatCurrency(value)}</td>`; });
             tableHTML += `<td>${formatCurrency(total)}</td></tr>`;

        } else if (isTotalLine) {
             const total = group.monthlyValues.reduce((a, b) => a + b, 0);
             tableHTML += `<tr class="highlight-row"><td>${group.account}</td>`;
             group.monthlyValues.forEach(value => { tableHTML += `<td>${formatCurrency(value)}</td>`; });
             tableHTML += `<td>${formatCurrency(total)}</td></tr>`;
        }
    });

    tableHTML += `</tbody></table>`;
    container.innerHTML = tableHTML;
}

function formatCurrency(v){
    const n = Number(String(v).replace(/[^0-9.-]+/g,""));
    return isFinite(n) ? n.toLocaleString('en-US', { style: 'currency', 'currency': 'USD' }) : '$0.00';
}
function formatPercent(v){
    const n=Number(v);
    if(!isFinite(n))return '-';
    const pct = n < 1 ? n * 100 : n; 
    return pct.toFixed(2)+'%';
}
</script>
</body>
</html>